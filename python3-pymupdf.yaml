name: python3-pymupdf
build-options:
  env:
    PYMUPDF_SETUP_MUPDF_BUILD: ''
    PYMUPDF_INCLUDES: /app/include
buildsystem: simple
build-commands:
  - ls -l /app/include/mupdf/
  - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
    --prefix=${FLATPAK_DEST} --no-build-isolation PyMuPDF
sources:
  - type: file
    url: https://files.pythonhosted.org/packages/8d/9a/e0a4e92a85fc17be7c54afdbb113f0ade2a8bca49856d510e28bd249e462/pymupdf-1.26.5.tar.gz
    sha256: 8ef335e07f648492df240f2247854d0e7c0467afb9c4dc2376ec30978ec158c3
    x-checker-data:
      type: pypi
      name: PyMuPDF

modules:
  - shared-modules/glu/glu-9.json
  - name: python3-clang
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} --no-build-isolation libclang
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/6e/5c/ca35e19a4f142adffa27e3d652196b7362fa612243e2b916845d801454fc/libclang-18.1.1.tar.gz
        sha256: a1214966d08d73d971287fc3ead8dfaf82eb07fb197680d8b3859dbbbbf78250
        x-checker-data:
          type: pypi
          name: libclang
    cleanup:
      - '*'

  - name: swig
    sources:
      - type: archive
        url: https://github.com/swig/swig/archive/refs/tags/v4.4.0.tar.gz
        sha256: 00735db2dc5abfae43c702dd927fc81a439e32d875839200cc0b5681cc70f66e
        x-checker-data:
          type: anitya
          project-id: 4919
          stable-only: true
          url-template: https://github.com/swig/swig/archive/refs/tags/v$version.tar.gz
    cleanup:
      - '*'

  - name: libgumbo
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/google/gumbo-parser/archive/v0.10.1.tar.gz
        sha256: 28463053d44a5dfbc4b77bcf49c8cee119338ffa636cc17fc3378421d714efad
        x-checker-data:
          type: anitya
          project-id: 214990
          stable-only: true
          url-template: https://github.com/google/gumbo-parser/archive/v$version.tar.gz
    cleanup:
      - /share/man/man1
      - /lib/pkgconfig
      - /include
      - '*.a'
      - '*.la'

  - name: Leptonica
    config-opts:
      - --disable-static
      - --with-pic
    sources:
      - type: archive
        url: http://www.leptonica.org/source/leptonica-1.85.0.tar.gz
        sha256: 3745ae3bf271a6801a2292eead83ac926e3a9bc1bf622e9cd4dd0f3786e17205
        x-checker-data:
          type: anitya
          project-id: 1549
          stable-only: true
          url-template: http://www.leptonica.org/source/leptonica-$version.tar.gz
    cleanup:
      - /bin
      - /share/man/man1

  - name: freeglut
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
      - -DFREEGLUT_BUILD_STATIC_LIBS=OFF
      - -DFREEGLUT_WAYLAND=ON
    sources:
      - type: archive
        url: https://github.com/FreeGLUTProject/freeglut/archive/refs/tags/v3.6.0.tar.gz
        sha256: 16de4f51dc1efd663a1a58ba5552e54f8783b77478289c95dca474a4d39ddd02
        x-checker-data:
          type: anitya
          project-id: 846
          stable-only: true
          url-template: https://github.com/FreeGLUTProject/freeglut/archive/refs/tags/v$version.tar.gz
      - type: patch
        paths:
          - python3-pymupdf-freeglut-0001-egl-fix-fgPlatformDestroyContext-prototype-for-C23.patch
    cleanup:
      - /share/man/man1
      - /include

  - name: mupdf
    build-options:
      env:
        LLVM_INSTALL_DIR: /usr/lib/sdk/llvm21
      append-path: /usr/lib/sdk/llvm21/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm21/lib
    no-autogen: true
    buildsystem: simple
    build-commands:
      - cd thirdparty/jbig2dec && ./autogen.sh && make && make prefix=/app install
      - make VENV_FLAG= prefix=/app shared=yes build=release pydir="/app/lib/python$(python3
        -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')/site-packages"
        libs install-shared-python
      - cp -r platform/c++/include/mupdf /app/include/
    sources:
      - type: archive
        url: https://mupdf.com/downloads/archive/mupdf-1.26.5-source.tar.gz
        sha256: a52daf7b2f41c5dc94d4691cd1e7cae25fc488556e614d8c3c4491d327473c40
        x-checker-data:
          type: anitya
          project-id: 2034
          stable-only: true
          url-template: https://mupdf.com/downloads/archive/mupdf-$version-source.tar.gz
      - type: shell
        commands:
          - |
            {
                printf "LINUX_OR_OPENBSD := yes\n"
                printf "USE_SYSTEM_LIBS := yes\n"
            } > user.make
    cleanup:
      - /bin
      - /share/man/man1
      - /include
      - '*.a'
      - '*.cmd'
